name: Deploy API Backend to EC2 (Staging)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ROLE: ${{ secrets.AWS_ROLE }}
  AWS_BUCKET_NAME: ${{ secrets.AWS_BUCKET_NAME }}
  AWS_BUCKET_KEY_NAME: ${{ secrets.AWS_BUCKET_KEY_NAME }}
  EC2_INSTANCE_ID: ${{ secrets.AWS_INSTANCE_ID }}
  API_PORT: 80

jobs:
  deploy-api:
    name: Deploy API backend
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ./apps/api-backend/go.mod
          cache: true
          cache-dependency-path: ./apps/api-backend/go.mod

      - name: Download dependencies
        working-directory: ./apps/api-backend
        run: |
          echo "Downloading Go dependencies..."
          go mod download
          go mod tidy
          go mod verify

      - name: Run tests
        working-directory: ./apps/api-backend
        run: |
          echo "Running Go tests..."
          go test -v ./...

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build Go API binary
        working-directory: ./apps/api-backend
        run: |
          echo "Building Go binary for Linux ARM64..."
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -o api-backend -ldflags="-s -w" .
          
          echo "Verifying binary was created..."
          if [ ! -f api-backend ]; then
            echo "Build failed - binary not found"
            exit 1
          fi
          
          echo "Binary info:"
          ls -lh api-backend
          file api-backend

      - name: Upload binary to S3
        run: |
          echo "Uploading binary to S3..."
          aws s3 cp ./apps/api-backend/api-backend \
            s3://${{ env.AWS_BUCKET_NAME }}/${{ env.AWS_BUCKET_KEY_NAME }} \
            --region ${{ env.AWS_REGION }}

      - name: Deploy to EC2 via SSM
        id: deploy
        run: |
          echo "Sending deploy command to EC2 instance..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ env.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy BoomChecker API Backend" \
            --parameters commands='[
              "echo Starting deploy on EC2...",
              "sudo systemctl stop boomchecker-api || echo Service not running",
              "sudo mkdir -p /opt/boomchecker/backup",
              "if [ -f /opt/boomchecker/api-backend ]; then sudo cp /opt/boomchecker/api-backend /opt/boomchecker/backup/api-backend.backup; fi",
              "sudo aws s3 cp s3://${{ env.AWS_BUCKET_NAME }}/${{ env.AWS_BUCKET_KEY_NAME }} /opt/boomchecker/api-backend",
              "sudo chmod +x /opt/boomchecker/api-backend",
              "echo Creating/updating systemd service with PORT=${{ env.API_PORT }}...",
              "echo \"[Unit]\" | sudo tee /etc/systemd/system/boomchecker-api.service > /dev/null",
              "echo \"Description=BoomChecker API Backend\" | sudo tee -a /etc/systemd/system/boomchecker-api.service > /dev/null",
              "echo \"After=network.target\" | sudo tee -a /etc/systemd/system/boomchecker-api.service > /dev/null",
              "echo \"\" | sudo tee -a /etc/systemd/system/boomchecker-api.service > /dev/null",
              "echo \"[Service]\" | sudo tee -a /etc/systemd/system/boomchecker-api.service > /dev/null",
              "echo \"Type=simple\" | sudo tee -a /etc/systemd/system/boomchecker-api.service > /dev/null",
              "echo \"User=ec2-user\" | sudo tee -a /etc/systemd/system/boomchecker-api.service > /dev/null",
              "echo \"WorkingDirectory=/opt/boomchecker\" | sudo tee -a /etc/systemd/system/boomchecker-api.service > /dev/null",
              "echo \"ExecStart=/opt/boomchecker/api-backend\" | sudo tee -a /etc/systemd/system/boomchecker-api.service > /dev/null",
              "echo \"Environment=PORT=${{ env.API_PORT }}\" | sudo tee -a /etc/systemd/system/boomchecker-api.service > /dev/null",
              "echo \"Restart=always\" | sudo tee -a /etc/systemd/system/boomchecker-api.service > /dev/null",
              "echo \"RestartSec=5\" | sudo tee -a /etc/systemd/system/boomchecker-api.service > /dev/null",
              "echo \"\" | sudo tee -a /etc/systemd/system/boomchecker-api.service > /dev/null",
              "echo \"[Install]\" | sudo tee -a /etc/systemd/system/boomchecker-api.service > /dev/null",
              "echo \"WantedBy=multi-user.target\" | sudo tee -a /etc/systemd/system/boomchecker-api.service > /dev/null",
              "sudo systemctl daemon-reload",
              "sudo systemctl enable boomchecker-api",
              "sudo systemctl start boomchecker-api",
              "echo Waiting for service to start...",
              "sleep 3",
              "sudo systemctl is-active boomchecker-api || exit 1"
            ]' \
            --region ${{ env.AWS_REGION }} \
            --output text \
            --query 'Command.CommandId')
          
          echo "Command ID: $COMMAND_ID"
          
          echo "Waiting for command to complete..."
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ env.EC2_INSTANCE_ID }}" \
            --region ${{ env.AWS_REGION }} \
            --cli-read-timeout 300 \
            --cli-connect-timeout 60
          
          echo "Checking command result..."
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ env.EC2_INSTANCE_ID }}" \
            --region ${{ env.AWS_REGION }} \
            --query 'Status' \
            --output text)
          
          echo "Command status: $STATUS"
          
          if [ "$STATUS" != "Success" ]; then
            echo "Deploy failed! Getting error details..."
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ env.EC2_INSTANCE_ID }}" \
              --region ${{ env.AWS_REGION }} \
              --query 'StandardErrorContent' \
              --output text
            exit 1
          fi
          
          echo "Deploy successful!"

      - name: Wait and verify service status
        id: verify
        run: |
          echo "Waiting for service to be fully ready..."
          sleep 5
          
          echo "Verifying BoomChecker API health..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ env.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Check BoomChecker API status" \
            --parameters commands='[
              "echo Checking systemd service status:",
              "sudo systemctl status boomchecker-api --no-pager || true",
              "echo",
              "echo Checking API health endpoint:",
              "response=$(curl -s -o /dev/null -w \"%{http_code}\" http://localhost:${{ env.API_PORT }}/ping)",
              "echo \"HTTP Status: $response\"",
              "if [ \"$response\" -ne 200 ]; then",
              "  echo \"Health check failed! API not responding correctly\"",
              "  exit 1",
              "fi",
              "echo \"API is healthy and responding\""
            ]' \
            --region ${{ env.AWS_REGION }} \
            --output text \
            --query 'Command.CommandId')
          
          echo "Health check command ID: $COMMAND_ID"
          
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ env.EC2_INSTANCE_ID }}" \
            --region ${{ env.AWS_REGION }}
          
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ env.EC2_INSTANCE_ID }}" \
            --region ${{ env.AWS_REGION }} \
            --query 'Status' \
            --output text)
          
          OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ env.EC2_INSTANCE_ID }}" \
            --region ${{ env.AWS_REGION }} \
            --query 'StandardOutputContent' \
            --output text)
          
          echo "$OUTPUT"
          
          if [ "$STATUS" != "Success" ]; then
            echo "Health check failed!"
            exit 1
          fi
          
          echo "Deployment completed successfully and API is healthy!"

      - name: Rollback on failure
        if: failure() && steps.deploy.conclusion == 'failure' || steps.verify.conclusion == 'failure'
        run: |
          echo "Deployment or health check failed! Attempting rollback..."
          
          ROLLBACK_COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ env.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Rollback BoomChecker API Backend" \
            --parameters commands='[
              "echo Performing rollback...",
              "if [ -f /opt/boomchecker/backup/api-backend.backup ]; then",
              "  sudo systemctl stop boomchecker-api || true",
              "  sudo cp /opt/boomchecker/backup/api-backend.backup /opt/boomchecker/api-backend",
              "  sudo chmod +x /opt/boomchecker/api-backend",
              "  sudo systemctl start boomchecker-api",
              "  echo Rollback completed - previous version restored",
              "else",
              "  echo No backup found - cannot rollback",
              "  exit 1",
              "fi"
            ]' \
            --region ${{ env.AWS_REGION }} \
            --output text \
            --query 'Command.CommandId')
          
          echo "Rollback command ID: $ROLLBACK_COMMAND_ID"
          
          aws ssm wait command-executed \
            --command-id "$ROLLBACK_COMMAND_ID" \
            --instance-id "${{ env.EC2_INSTANCE_ID }}" \
            --region ${{ env.AWS_REGION }} || echo "Rollback command timed out"
          
          echo "Deployment failed and rollback attempted. Please check the EC2 instance manually."
